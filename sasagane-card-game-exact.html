<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹é‹ï¼ã•ã•ãŒã­ç¥çµŒè¡°å¼±</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®ãƒ‘ã‚¹ï¼ˆ8ç¨®é¡ã§ãƒšã‚¢ã‚’ä½œã‚‹ï¼‰
        const cardValues = [
            'cryptoNinjaImage/sasagane.png',
            'cryptoNinjaImage/sakuya.png', 
            'cryptoNinjaImage/benten.png',
            'cryptoNinjaImage/izuna.png',
            'cryptoNinjaImage/kohaku.png',
            'cryptoNinjaImage/konga.png',
            'cryptoNinjaImage/nemu.png',
            'cryptoNinjaImage/seori.png'
        ];

        function CardMatching() {
            const [gameState, setGameState] = useState('waiting');
            const [cards, setCards] = useState([]);
            const [flippedCards, setFlippedCards] = useState([]);
            const [mistakes, setMistakes] = useState(0);
            const [matches, setMatches] = useState(0);
            const [lockEndTime, setLockEndTime] = useState(null);
            const [timeLeft, setTimeLeft] = useState(0);
            const [playCount, setPlayCount] = useState(0);

            const initializeCards = () => {
                const duplicatedValues = [...cardValues, ...cardValues];
                const shuffledCards = duplicatedValues
                    .sort(() => Math.random() - 0.5)
                    .map((value, index) => ({
                        id: index,
                        value,
                        isFlipped: false,
                        isMatched: false,
                    }));
                setCards(shuffledCards);
            };

            const checkLockStatus = () => {
                const stored = localStorage.getItem('sasaganeCardGame');
                if (stored) {
                    const data = JSON.parse(stored);
                    const now = Date.now();
                    
                    if (data.lockEndTime && now < data.lockEndTime) {
                        setLockEndTime(data.lockEndTime);
                        setPlayCount(data.playCount || 0);
                        setGameState('locked');
                        return true;
                    } else if (data.lockEndTime && now >= data.lockEndTime) {
                        // Lock expired, reset play count
                        localStorage.setItem('sasaganeCardGame', JSON.stringify({ 
                            playCount: 0, 
                            lockEndTime: null 
                        }));
                        setPlayCount(0);
                    } else {
                        setPlayCount(data.playCount || 0);
                    }
                }
                return false;
            };

            const startGame = () => {
                if (checkLockStatus()) return;
                
                const currentPlayCount = playCount + 1;
                setPlayCount(currentPlayCount);
                
                if (currentPlayCount >= 2) {
                    // Lock for 30 minutes after 2 plays
                    const lockTime = Date.now() + 30 * 60 * 1000;
                    setLockEndTime(lockTime);
                    localStorage.setItem('sasaganeCardGame', JSON.stringify({ 
                        playCount: currentPlayCount, 
                        lockEndTime: lockTime 
                    }));
                    setGameState('locked');
                    return;
                } else {
                    localStorage.setItem('sasaganeCardGame', JSON.stringify({ 
                        playCount: currentPlayCount, 
                        lockEndTime: null 
                    }));
                }

                setGameState('playing');
                setMistakes(0);
                setMatches(0);
                setFlippedCards([]);
                initializeCards();
            };

            const handleCardClick = (clickedCard) => {
                if (gameState !== 'playing' || 
                    clickedCard.isFlipped || 
                    clickedCard.isMatched || 
                    flippedCards.length >= 2) {
                    return;
                }

                const newCard = { ...clickedCard, isFlipped: true };
                const newCards = cards.map(card => 
                    card.id === clickedCard.id ? newCard : card
                );
                setCards(newCards);

                const newFlippedCards = [...flippedCards, newCard];
                setFlippedCards(newFlippedCards);

                if (newFlippedCards.length === 2) {
                    setTimeout(() => {
                        checkMatch(newFlippedCards);
                    }, 1000);
                }
            };

            const checkMatch = (flippedCards) => {
                const [card1, card2] = flippedCards;
                
                if (card1.value === card2.value) {
                    // Match found
                    setCards(prev => prev.map(card => 
                        card.id === card1.id || card.id === card2.id 
                            ? { ...card, isMatched: true }
                            : card
                    ));
                    
                    const newMatches = matches + 1;
                    setMatches(newMatches);
                    
                    if (newMatches === 8) {
                        setTimeout(() => setGameState('result'), 500);
                    }
                } else {
                    // No match
                    setCards(prev => prev.map(card => 
                        card.id === card1.id || card.id === card2.id 
                            ? { ...card, isFlipped: false }
                            : card
                    ));
                    
                    const newMistakes = mistakes + 1;
                    setMistakes(newMistakes);
                    
                    if (newMistakes >= 2) {
                        setTimeout(() => setGameState('result'), 500);
                    }
                }
                
                setFlippedCards([]);
            };

            const resetGame = () => {
                setGameState('waiting');
                setCards([]);
                setFlippedCards([]);
                setMistakes(0);
                setMatches(0);
            };

            useEffect(() => {
                checkLockStatus();
            }, []);

            useEffect(() => {
                let timer;
                if (gameState === 'locked' && lockEndTime) {
                    const updateTimer = () => {
                        const now = Date.now();
                        const remaining = Math.max(0, lockEndTime - now);
                        setTimeLeft(remaining);
                        
                        if (remaining <= 0) {
                            setGameState('waiting');
                            setLockEndTime(null);
                            localStorage.setItem('sasaganeCardGame', JSON.stringify({ 
                                playCount: 0, 
                                lockEndTime: null 
                            }));
                        }
                    };
                    
                    updateTimer();
                    timer = setInterval(updateTimer, 1000);
                }
                
                return () => {
                    if (timer) clearInterval(timer);
                };
            }, [gameState, lockEndTime]);

            const formatTime = (ms) => {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            };

            if (gameState === 'locked') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-purple-100 to-pink-100 flex flex-col items-center justify-center p-4">
                        <h1 className="text-4xl font-bold text-purple-800 mb-8">é–‹é‹ï¼ã•ã•ãŒã­ç¥çµŒè¡°å¼±</h1>
                        
                        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                            <div className="text-6xl mb-6">â°</div>
                            <h2 className="text-2xl font-bold text-red-600 mb-4">ãƒ—ãƒ¬ã‚¤åˆ¶é™ä¸­</h2>
                            <p className="text-lg mb-4">
                                30åˆ†é–“ã«2å›ãƒ—ãƒ¬ã‚¤ã—ã¾ã—ãŸ
                            </p>
                            <p className="text-sm text-gray-600 mb-6">
                                æ®‹ã‚Šæ™‚é–“: {formatTime(timeLeft)}
                            </p>
                            <p className="text-sm text-gray-500">
                                ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„
                            </p>
                        </div>
                    </div>
                );
            }

            if (gameState === 'waiting') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-purple-100 to-pink-100 flex flex-col items-center justify-center p-4">
                        <h1 className="text-4xl font-bold text-purple-800 mb-8">é–‹é‹ï¼ã•ã•ãŒã­ç¥çµŒè¡°å¼±</h1>
                        
                        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mb-8 text-center">
                            <div className="text-6xl mb-6">ğŸƒ</div>
                            <p className="text-lg font-bold text-purple-600 mb-6">è¨˜æ†¶åŠ›ãƒãƒ£ãƒ¬ãƒ³ã‚¸</p>
                            <p className="text-sm text-gray-600 mb-6">
                                åŒã˜çµµæŸ„ã®ã‚«ãƒ¼ãƒ‰ã‚’2æšãƒšã‚¢ã«ã—ã¦ãã ã•ã„ï¼<br />
                                å…¨8ãƒšã‚¢å®Œæˆã§ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢<br />
                                2å›ãƒŸã‚¹ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
                            </p>
                            <div className="text-sm text-gray-500 mb-4">
                                ãƒ—ãƒ¬ã‚¤å›æ•°: {playCount}/2 (30åˆ†åˆ¶é™)
                            </div>
                        </div>
                        
                        <button
                            onClick={startGame}
                            className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-8 rounded-lg text-xl"
                        >
                            ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹
                        </button>
                    </div>
                );
            }

            if (gameState === 'playing') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-purple-100 to-pink-100 flex flex-col items-center justify-center p-4">
                        <h1 className="text-4xl font-bold text-purple-800 mb-8">é–‹é‹ï¼ã•ã•ãŒã­ç¥çµŒè¡°å¼±</h1>
                        
                        <div className="bg-white rounded-lg shadow-lg p-6 max-w-2xl w-full">
                            <div className="flex justify-between items-center mb-6">
                                <div className="text-lg font-bold text-gray-700">
                                    ãƒšã‚¢: {matches}/8
                                </div>
                                <div className={`text-lg font-bold ${mistakes >= 1 ? 'text-red-600' : 'text-gray-700'}`}>
                                    ãƒŸã‚¹: {mistakes}/2
                                </div>
                            </div>

                            <div className="grid grid-cols-4 gap-3 mb-6">
                                {cards.map((card) => (
                                    <button
                                        key={card.id}
                                        onClick={() => handleCardClick(card)}
                                        disabled={card.isFlipped || card.isMatched || flippedCards.length >= 2}
                                        className={`w-20 h-20 rounded-lg border-2 flex items-center justify-center text-2xl font-bold transition-all duration-300 overflow-hidden ${
                                            card.isMatched
                                                ? 'bg-green-200 border-green-400 text-green-800'
                                                : card.isFlipped
                                                ? 'bg-white border-purple-400'
                                                : 'bg-purple-200 border-purple-300 hover:bg-purple-300'
                                        }`}
                                    >
                                        {card.isFlipped || card.isMatched ? (
                                            <img 
                                                src={card.value} 
                                                alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼" 
                                                className="w-full h-full object-cover rounded"
                                                onError={(e) => {
                                                    e.target.style.display = 'none';
                                                    e.target.nextSibling.style.display = 'inline';
                                                }}
                                            />
                                        ) : '?'}
                                        <span style={{display: 'none'}} className="text-lg">ğŸ</span>
                                    </button>
                                ))}
                            </div>

                            <div className="text-center text-sm text-gray-600">
                                ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦çµµæŸ„ã‚’ç¢ºèªã—ã‚ˆã†ï¼
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'result') {
                const isWin = matches === 8;
                
                return (
                    <div className="min-h-screen bg-gradient-to-b from-purple-100 to-pink-100 flex flex-col items-center justify-center p-4">
                        <h1 className="text-4xl font-bold text-purple-800 mb-8">é–‹é‹ï¼ã•ã•ãŒã­ç¥çµŒè¡°å¼±</h1>
                        
                        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                            <div className="text-6xl mb-6">
                                {isWin ? 'ğŸ‰' : 'ğŸ˜…'}
                            </div>
                            
                            <h2 className="text-2xl font-bold mb-4">
                                {isWin ? 'ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼' : 'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼'}
                            </h2>
                            
                            <p className="text-lg mb-4">
                                ãƒšã‚¢æ•°: {matches}/8
                            </p>

                            <div className="mb-6">
                                <p className="text-sm text-gray-600">
                                    {isWin 
                                        ? 'ç´ æ™´ã‚‰ã—ã„è¨˜æ†¶åŠ›ã§ã™ï¼' 
                                        : `${mistakes}å›ãƒŸã‚¹ã—ã¾ã—ãŸ`
                                    }
                                </p>
                            </div>

                            <button
                                onClick={resetGame}
                                className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg"
                            >
                                ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
                            </button>
                        </div>
                    </div>
                );
            }

            return null;
        }

        ReactDOM.render(<CardMatching />, document.getElementById('app'));
    </script>
</body>
</html>